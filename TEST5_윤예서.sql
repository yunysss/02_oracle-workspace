--1
DROP TABLE TB_MEMBER;

CREATE TABLE TB_MEMBER(
    MEM_NO NUMBER PRIMARY KEY,
    MEM_ID VARCHAR2(30) NOT NULL UNIQUE,
    MEM_PWD VARCHAR2(30) NOT NULL,
    MEM_NAME VARCHAR2(20) NOT NULL,
    MEM_ADDR VARCHAR2(50),
    MEM_GEN CHAR(1) CHECK(MEM_GEN IN ('M', 'F')),
    ENROLL_DATE DATE DEFAULT SYSDATE NOT NULL,
    MODIFY_DATE DATE DEFAULT SYSDATE NOT NULL,
    WITHDRAWAL_DATE DATE,
    ADMIN_YN CHAR(1) DEFAULT 'N' NOT NULL CHECK(ADMIN_YN IN ('Y', 'N'))
);

DROP TABLE TB_PRODUCT;

CREATE TABLE TB_PRODUCT(
    PRO_CODE VARCHAR2(10) PRIMARY KEY,
    PRO_NAME VARCHAR2(30) NOT NULL,
    PRO_BRAND VARCHAR2(20) NOT NULL,
    PRO_PRICE NUMBER,
    PRO_STOCK NUMBER,
    CATEGORY VARCHAR2(20) DEFAULT '기타' NOT NULL CHECK(CATEGORY IN ('의류', '신발', '잡화', '생활용품', '기타')),
    REGIST_DATE DATE DEFAULT SYSDATE NOT NULL
);

DROP TABLE TB_OPTION;

CREATE TABLE TB_OPTION(
    OPT_CODE VARCHAR2(10) PRIMARY KEY,
    OPT_NAME VARCHAR2(30) NOT NULL,
    OPT_PRICE NUMBER,
    OPT_STOCK NUMBER DEFAULT 0 NOT NULL,
    REGIST_DATE DATE DEFAULT SYSDATE NOT NULL,
    REF_PRO_CODE VARCHAR2(10) REFERENCES TB_PRODUCT NOT NULL
);

DROP TABLE TB_LIKE;

CREATE TABLE TB_LIKE(
    MEM_NO NUMBER REFERENCES TB_MEMBER,
    PRO_CODE VARCHAR2(10) REFERENCES TB_PRODUCT,
    LIKE_DATE DATE NOT NULL,
    PRIMARY KEY(MEM_NO, PRO_CODE)
);

DROP TABLE TB_REVIEW;

CREATE TABLE TB_REVIEW(
    REVIEW_NO NUMBER PRIMARY KEY,
    REVIEW_CONTENT VARCHAR2(4000) NOT NULL,
    RATING NUMBER DEFAULT 5 NOT NULL CHECK(RATING BETWEEN 1 AND 5),
    REGIST_DATE DATE DEFAULT SYSDATE NOT NULL,
    MEM_NO NUMBER REFERENCES TB_MEMBER NOT NULL,
    PRO_CODE VARCHAR2(10) REFERENCES TB_PRODUCT NOT NULL
);

--2
INSERT INTO TB_MEMBER VALUES(30000, 'admin', 1234, '관리자', NULL, NULL, SYSDATE, SYSDATE, NULL, 'Y');
INSERT INTO TB_MEMBER VALUES(30001, 'user01', 'pass01', '강길동', '서울시 양천구', 'M', SYSDATE, SYSDATE, NULL, 'N');
INSERT INTO TB_MEMBER VALUES(30002, 'user02', 'pass02', '김개화', '서울시 송파구', 'F', SYSDATE, SYSDATE, NULL, 'N');
INSERT INTO TB_MEMBER VALUES(30003, 'user03', 'pass03', '강현수', '서울시 강동구', 'M', SYSDATE, SYSDATE, NULL, 'N');

INSERT INTO TB_PRODUCT VALUES('PRO_001', '샤랄라바지', 'NAIN', 25000, 10, '의류', SYSDATE);
INSERT INTO TB_PRODUCT VALUES('PRO_002', '볼펜', '모나미', NULL, NULL, '생활용품', SYSDATE);
INSERT INTO TB_PRODUCT VALUES('PRO_003', '마우스', '로지텍', NULL, NULL, '잡화', SYSDATE);

INSERT INTO TB_OPTION VALUES('OPT_001', '검정색', 700, 150, SYSDATE, 'PRO_002');
INSERT INTO TB_OPTION VALUES('OPT_002', '빨간색', 1000, 200, SYSDATE, 'PRO_002');
INSERT INTO TB_OPTION VALUES('OPT_003', 'MX MASTER 3', 90000, 3, SYSDATE, 'PRO_003');
INSERT INTO TB_OPTION VALUES('OPT_004', 'G304', 15000, 2, SYSDATE, 'PRO_003');

INSERT INTO TB_LIKE VALUES(30001, 'PRO_003', SYSDATE);
INSERT INTO TB_LIKE VALUES(30002, 'PRO_001', SYSDATE);
INSERT INTO TB_LIKE VALUES(30001, 'PRO_001', SYSDATE);
INSERT INTO TB_LIKE VALUES(30003, 'PRO_002', SYSDATE);

INSERT INTO TB_REVIEW VALUES(1, '상품 설명처럼 너무 샤랄라하니 이쁘네요~! 잘 입겠습니다~~', 5, SYSDATE, 30002, 'PRO_001');
INSERT INTO TB_REVIEW VALUES(2, '역시 볼펜은 모나미! 근데 잘 안나와요..재구매 의사 없습니다.', 2, SYSDATE, 30003, 'PRO_002');
INSERT INTO TB_REVIEW VALUES(3, '마우스는 로지텍만 한게 없죠 MX MASTER 너무 좋네요', 4, SYSDATE, 30001, 'PRO_003');

--3_1) 30001번 회원이 찜한 상품들의 상품코드, 상품명, 브랜드명, 상품가격 조회 
SELECT PRO_CODE "상품코드", PRO_NAME "상품명", PRO_BRAND "브랜드명", PRO_PRICE "상품가격"
  FROM TB_LIKE
  JOIN TB_PRODUCT USING(PRO_CODE)
 WHERE MEM_NO = 30001;
 
--3_2) PRO_001 상품에 대해 찜한 횟수 조회  
SELECT COUNT(*)
  FROM TB_LIKE
 WHERE PRO_CODE = 'PRO_001'; 

--3_3) 전체 리뷰들의 리뷰번호, 리뷰내용, 평점, 상품명, 작성자회원아이디, 작성일(XXXX-XX-XX형식) 조회 

   --단, 리뷰번호 내림차순으로 정렬하여 최신글이 먼저 조회되도록 하시오
SELECT REVIEW_NO "리뷰번호"
     , REVIEW_CONTENT "리뷰내용"
     , RATING "평점"
     , PRO_NAME "상품명"
     , MEM_ID "작성자회원아이디"
     , TO_CHAR(R.REGIST_DATE, 'YYYY-MM-DD') "작성일"
  FROM TB_REVIEW R
  JOIN TB_PRODUCT USING(PRO_CODE)
  JOIN TB_MEMBER USING(MEM_NO)
ORDER BY 1 DESC;  

--3_4) PRO_003 상품의 리뷰 평균 평점을 조회 

   --단, 무조건 소수점 아래 한자리까지 표현될 수 있도록 하시오 (예를 들어 평균평점이 4일때도 4.0으로 조회될 수 있도록)
   
SELECT TO_CHAR(AVG(RATING), '0.0')
  FROM TB_REVIEW 
 WHERE PRO_CODE = 'PRO_003';
